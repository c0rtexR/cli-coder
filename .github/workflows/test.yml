name: üß™ Test Suite

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'package*.json'
      - 'tsconfig.json'
      - 'vitest.config.ts'
      - 'eslint.config.js'
      - '.github/workflows/**'
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

env:
  NODE_VERSION: '20'
  CACHE_VERSION: 'v1'

jobs:
  # üîç Code Quality Checks
  lint-and-typecheck:
    name: üîç Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üîç Run ESLint
        run: npm run lint

      - name: üîß Run TypeScript type checking
        run: npm run type-check

  # üß™ Unit Tests
  unit-tests:
    name: üß™ Unit Tests
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üß™ Run unit tests
        run: npm run test:unit

      - name: üìä Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: unit-tests
          name: unit-tests-coverage

  # üîó Integration Tests
  integration-tests:
    name: üîó Integration Tests
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üîó Run integration tests
        run: npm run test:integration

  # üé≠ End-to-End Tests
  e2e-tests:
    name: üé≠ E2E Tests
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üèóÔ∏è Build project
        run: npm run build

      - name: üé≠ Run E2E tests
        run: npm run test:e2e

  # üåç Real Environment Tests
  real-tests:
    name: üåç Real Environment Tests
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    # Only run on main branch or when explicitly triggered
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üèóÔ∏è Build project
        run: npm run build

      - name: üåç Run real environment tests
        run: npm run test:real
        env:
          # Add any required environment variables for real tests
          TEST_ENV: 'github-actions'

  # ‚úÖ Test Matrix (Multiple Node versions)
  test-matrix:
    name: üß™ Node ${{ matrix.node-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: lint-and-typecheck
    strategy:
      fail-fast: false
      matrix:
        node-version: ['18', '20', '22']
        os: [ubuntu-latest, windows-latest, macos-latest]
        # Only test critical combinations to avoid excessive job runs
        exclude:
          - os: windows-latest
            node-version: '18'
          - os: macos-latest
            node-version: '18'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üß™ Run core test suite
        run: npm run test:ci # Unit + Integration tests

  # üìä Test Summary
  test-summary:
    name: üìä Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, test-matrix]
    if: always()
    steps:
      - name: üìä Summary
        run: |
          echo "## üß™ Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| üß™ Unit Tests | ${{ needs.unit-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üîó Integration Tests | ${{ needs.integration-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY  
          echo "| üé≠ E2E Tests | ${{ needs.e2e-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üß™ Matrix Tests | ${{ needs.test-matrix.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.unit-tests.result }}" == "success" && \
                "${{ needs.integration-tests.result }}" == "success" && \
                "${{ needs.e2e-tests.result }}" == "success" && \
                "${{ needs.test-matrix.result }}" == "success" ]]; then
            echo "üéâ **All tests passed!** This PR is ready for review." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Some tests failed.** Please check the failing jobs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

# üõ°Ô∏è Security and Performance
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true